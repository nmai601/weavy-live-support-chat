<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Filepicker demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.0/styles/a11y-dark.min.css">
    <style>
        .dropup .dropdown-toggle::after {
            display: none;
        }

        .dropdown-item {
            display: flex;
            padding-left: 1rem;
        }
            
        .dropdown-item svg {
            margin-right: .3rem;
        }

            .dropdown-toggle {
                display: flex;
            }

        body {
            
        }

        .card {
            margin-top: 1.7rem;
        }

        .weavy-container {
            height: 1px;
        }
        .max {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: unset !important;
        }
    </style>
</head>
<body class="my-4">
    <div class="container-fluid">
        <div class="row">

            <div class="col-6">
                <h3>Cloudpicker demo</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="btn-group dropup filebrowser">
                            <button aria-expanded="false" aria-haspopup="true" class="btn btn-icon dropdown-toggle" id="cloudpicker" data-toggle="dropdown" type="button" disabled="disabled">
                                <svg height="24" viewBox="0 0 24 24" width="24" class="i i-attachment"><path d="m7.5 18c-3.04 0-5.5-2.46-5.5-5.5s2.46-5.5 5.5-5.5h10.5c2.21 0 4 1.79 4 4s-1.79 4-4 4h-8.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5h7.5v1.5h-7.5c-.55 0-1 .45-1 1s.45 1 1 1h8.5c1.38 0 2.5-1.12 2.5-2.5s-1.12-2.5-2.5-2.5h-10.5c-2.21 0-4 1.79-4 4s1.79 4 4 4h9.5v1.5z"></path></svg>
                                &nbsp; Pick a file
                            </button>
                            <div class="dropdown-menu" role="menu" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(0px, 32px, 0px);">
                                <a class="dropdown-item" href="javascript:;" data-chooser="box"><svg height="24" viewBox="0 0 24 24" width="24" class="i i-box text-native"><path d="m15.39 14.04c0-1.42-1.15-2.57-2.57-2.57-1.41 0-2.56 1.15-2.56 2.57 0 1.41 1.15 2.56 2.56 2.56 1.42 0 2.57-1.15 2.57-2.56m1.71 0c0 2.36-1.92 4.27-4.28 4.27-1.63 0-3.05-.92-3.77-2.27-.72 1.35-2.14 2.27-3.77 2.27-2.34 0-4.24-1.88-4.28-4.2v-7.11c0-.44.39-.82.86-.82s.84.38.85.82v3.62c.72-.54 1.61-.86 2.57-.86 1.63 0 3.05.92 3.77 2.27.72-1.35 2.14-2.27 3.77-2.27 2.36 0 4.28 1.92 4.28 4.28zm-9.26 0c0-1.42-1.15-2.57-2.56-2.57-1.42 0-2.57 1.15-2.57 2.57 0 1.41 1.15 2.56 2.57 2.56 1.41 0 2.56-1.15 2.56-2.56m15 2.92c.11.16.16.34.16.51 0 .26-.12.53-.34.68-.16.11-.33.17-.51.17-.25 0-.5-.11-.65-.32l-1.91-2.53-1.89 2.53c-.17.21-.42.32-.67.32-.18 0-.36-.06-.53-.17-.21-.15-.33-.43-.33-.69 0-.17.06-.35.16-.5l2.17-2.92-2.17-2.93c-.11-.15-.16-.32-.16-.5 0-.26.12-.51.33-.68.39-.28.91-.21 1.2.16l1.89 2.52 1.91-2.52c.26-.37.79-.44 1.16-.16.23.17.34.43.34.7 0 .17-.05.34-.16.48l-2.18 2.93z" fill="#22a7f0"></path></svg> Box</a><a class="dropdown-item" href="javascript:;" data-chooser="dropbox"><svg height="24" viewBox="0 0 24 24" width="24" class="i i-dropbox text-native"><path d="m12 14.56 4.35 3.6 1.85-1.21v1.35l-6.2 3.7-6.18-3.7v-1.35l1.86 1.21zm-4.32-12.06 4.32 3.59 4.32-3.59 6.18 4-4.27 3.44 4.27 3.42-6.18 4.03-4.32-3.61-4.32 3.61-6.18-4.03 4.27-3.42-4.27-3.44zm4.32 11.18 6.13-3.74-6.13-3.75-6.13 3.75z" fill="#007ee5"></path></svg> Dropbox</a><a class="dropdown-item" href="javascript:;" data-chooser="google-drive"><svg height="24" viewBox="0 0 24 24" width="24" class="i i-google-drive text-native"><path d="m7.71 3.5-6.56 11.5 3.43 6 6.55-11.5" fill="#0f9d58"></path><path d="m9.73 15-3.43 6h13.12l3.43-6" fill="#4285f4"></path><path d="m22.28 14-6.86-12h-6.84-.01l6.86 12z" fill="#f4b400"></path></svg> Google Drive</a><a class="dropdown-item" href="javascript:;" data-chooser="onedrive"><svg height="24" viewBox="0 0 24 24" width="24" class="i i-onedrive text-native"><path d="m20.08 13.64c1.09.17 1.92 1.11 1.92 2.25 0 .89-.5 1.66-1.25 2.03l-.17.08h-11.4-.02c-1.45 0-2.62-1.19-2.62-2.64 0-1.46 1.18-2.64 2.64-2.64l.22.01-.01-.2c0-1.82 1.48-3.3 3.3-3.3 1.28 0 2.39.73 2.94 1.77.45-.27.99-.45 1.58-.45 1.59 0 2.88 1.29 2.88 2.88zm-11.26-1.48c-1.61.18-2.86 1.54-2.86 3.2 0 .68.21 1.3.54 1.82h-1.77c-1.51 0-2.73-1.22-2.73-2.73 0-1.45 1.12-2.62 2.53-2.72l-.07-.67c0-1.7 1.38-3.06 3.08-3.06.63 0 1.23.18 1.72.5.69-1.39 2.14-2.35 3.81-2.35 2.2 0 4.01 1.68 4.23 3.82h-.09c-.48 0-.94.1-1.37.28-.72-1-1.88-1.61-3.15-1.61-2.02 0-3.69 1.55-3.87 3.52z" fill="#3047ac"></path></svg> OneDrive</a>
                            </div>
                        </div>
                        <span id="filename"></span>

                    </div>
                </div>
                <div id="weavy-container"></div>
            </div>

            <div class="col-6" style="min-height:400px">
                <h3>Result</h3>
<pre>
                <code class="language-json" id="result">
    The output from the pickers will be shown here...
    </code>
</pre>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="/javascript/weavy.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js" integrity="sha384-LtrjvnR4Twt/qOuYxE721u19sVFLVSA4hf/rRt6PrZTmiPltdZcI7q7PXQBYTKyf" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.0/highlight.min.js"></script>
    <script>

      $(document).on("click", "[data-chooser]", function (e) {
        console.log("app", app);
            var $appFrame = $(app.panel).find(".weavy-panel-frame");
            $appFrame[0].contentWindow.postMessage({ name: "externalCloudOpen", provider: $(this).data("chooser"), multiple: false }, "*");

            if ($(this).data("chooser") === "google-drive") {
                $("#weavy-container").addClass("max");
            }

            return true;
        });

        window.addEventListener("message", function (e) {
            if (e.data.name === "result") {
                $("#result").text(JSON.stringify(JSON.parse(e.data.files[0].raw), null, 4));
                $("#filename").text(e.data.files[0].name);
                hljs.highlightBlock($("#result")[0]);
            } else if (e.data.name === "closePicker") {
                $("#weavy-container").removeClass("max");
            } else if (e.data.name === "request:connection-start") {
                // enable when connected? should be a better event?
                $("#cloudpicker").prop("disabled", false);
            }

        });

        // ClientID = clientid / ClientSecret = clientsecret
        var token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkxIiwibmFtZSI6IkZpbGVzIEJvdCIsImlzcyI6ImNsaWVudGlkIiwiZXhwIjoyMTIyMTIyMjIzLCJjbGllbnRfaWQiOiJjbGllbnRpZCJ9.lM4cR3LshffbNRtJXk0042GgTuHdS6bbRdhfcnOXmBY";
        var appId = null;
        var contentId = null;

        // submit form on change
        $("input[type=file]").on("change", function (e) {
            $("form").submit();
        });

        $("form").on("submit", function (e) {
            e.preventDefault();

            var url = "";
            if (contentId) {
                url = weavy.httpsUrl("api/content/" + contentId + "/files", weavy.options.url);
            } else if (appId) {
                url = weavy.httpsUrl("api/apps/" + appId + "/files", weavy.options.url);
            } else {
                return;
            }

            var form = this;
            var files = $("input[type=file]", $(form))[0].files;
            var fd = new FormData();
            $.each(files, function (i, file) {
                fd.append('file-' + i, file);
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fd,
                contentType: false,
                processData: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                }
            }).then(function (response) {
                console.log(response);
            }).always(function () {
                // reset form and reload files app
                form.reset();
                app.panel.reload();
            });
        })

        var weavy = new Weavy({
            jwt: token
        });

        var space = weavy.space({ key: "demo" });
        var app = space.app({ key: "files-demo", type: "files", container: "#weavy-container" });
        app.whenBuilt().then(function () {
            appId = app.id;
            var windowName = $(app.panel).find("iframe")[0].name;
            weavy.on(wvy.postal, "custom-nav", { weavyId: weavy.getId(), windowName: windowName }, function (e, data) {
                appId = data.app;
                contentId = data.content;
            });
        })

        hljs.initHighlightingOnLoad();
    </script>
    <iframe id="filebrowser" src="about:blank" style="display:none;width:100%;height:100%;z-index:99999999;position:fixed;top:0;left:0;border:0;"></iframe>
</body>
</html>
